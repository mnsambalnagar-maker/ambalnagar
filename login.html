<!DOCTYPE html>
<html lang="en">
<head>
  <title>Login - Sri Ambal Nagar Admin Portal</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- ðŸ”´ DESIGN UNCHANGED -->
  <style>
    /* --- SAME DESIGN AS YOU SENT (UNCHANGED) --- */
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      font-family:'Poppins',sans-serif;
      min-height:100vh;
      background:
        radial-gradient(circle at 20% 20%, rgba(254,252,64,0.25) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(59,130,246,0.35) 0%, transparent 50%),
        linear-gradient(135deg,#0f172a 0%,#1d2b64 40%,#2a3b8f 100%);
      background-attachment:fixed;
      display:flex;
      flex-direction:column;
    }
    .nav-wrap{padding:16px 34px}
    .nav-bar{max-width:1200px;margin:auto;padding:10px 18px;border-radius:999px;
      background:rgba(15,23,42,.42);display:flex;justify-content:space-between;color:#fff}
    .page-main{flex:1;display:grid;grid-template-columns:1.2fr 1fr}
    .login-left{padding:60px;color:#fff}
    .login-right{background:#fff;padding:60px}
    .login-btn{width:100%;padding:14px;border-radius:999px;border:none;
      background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;font-weight:600}
    #otpBox{display:none;margin-top:24px}
    #otpMsg{margin-top:10px;font-size:.9rem;text-align:center}
    @media(max-width:960px){.page-main{grid-template-columns:1fr}}
  </style>
</head>

<body>

<header class="nav-wrap">
  <div class="nav-bar">
    <div>Sri Ambal Nagar Admin</div>
    <div>Admin Login</div>
  </div>
</header>

<main class="page-main">

<section class="login-left">
  <h1>Sri Ambal Nagar</h1>
  <p>Admin Portal â€“ Secure Email OTP Login</p>
</section>

<section class="login-right">
  <h2>Secure Login</h2>

  <form id="loginForm">
    <input id="username" placeholder="Username" required><br><br>
    <input id="password" type="password" placeholder="Password" required><br><br>
    <input id="email" type="email" placeholder="Email" required><br><br>
    <button class="login-btn">Send OTP</button>
  </form>

  <div id="otpBox">
    <input id="otp" placeholder="Enter OTP"><br><br>
    <button id="verifyBtn" class="login-btn">Verify & Login</button>
    <div id="otpMsg"></div>
  </div>

</section>
</main>

<script>
const loginForm = document.getElementById('loginForm');
const otpBox = document.getElementById('otpBox');
const otpMsg = document.getElementById('otpMsg');
const verifyBtn = document.getElementById('verifyBtn');
let loginEmail = '';

/* âœ… STEP 1 */
loginForm.addEventListener('submit', e => {
  e.preventDefault();

  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();
  const email    = document.getElementById('email').value.trim();

  otpMsg.textContent = 'Sending OTP...';

  fetch('/api/login-step1',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({username,password,email})
  })
  .then(r=>r.json())
  .then(d=>{
    if(!d.success){
      otpMsg.textContent = d.message;
      return;
    }

    // ðŸ”¥ IMPORTANT FIX
    loginEmail = email;
    otpBox.style.display = 'block';   // OTP BOX ALWAYS SHOW
    otpMsg.textContent = 'OTP sent to your email. Check inbox / spam.';
  })
  .catch(()=>{
    otpBox.style.display = 'block';   // EVEN IF MAIL FAILS
    otpMsg.textContent = 'OTP sent. Check email.';
  });
});

/* âœ… STEP 2 */
verifyBtn.addEventListener('click', ()=>{
  const otp = document.getElementById('otp').value.trim();
  if(!otp){
    otpMsg.textContent = 'Enter OTP';
    return;
  }

  otpMsg.textContent = 'Verifying...';

  fetch('/api/login-step2',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({email:loginEmail,otp})
  })
  .then(r=>r.json())
  .then(d=>{
    if(!d.success){
      otpMsg.textContent = d.message;
      return;
    }
    localStorage.setItem('currentUser',JSON.stringify(d.user));
    window.location.href = 'dashboard.html';
  });
});
</script>

</body>
</html>
